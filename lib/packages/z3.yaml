package: z3

versions: ["4.5.0", "4.6.0", "4.7.1", "4.8.1", "4.8.3", "4.8.4" ]

dependencies:
  - version: ">=4.5.0"
    aliases: []
    install: [ python, c++-compiler, c-compiler ]
    build: [ default-c ]

  - version: ">=4.6.0"
    aliases: []
    install: [ c++-compiler, c-compiler ]
    build: [ default-c ]

variables:
  - version: ">=4.5.0"
    url: https://github.com/Z3Prover/z3
    commit: z3-$PACKAGE_VERSION

download:
  - version: ">=4.5.0"
    shell: |
      git clone "$url" download
      (cd download && git checkout -b spock $commit)
      (cd download && git archive --format=tar --prefix=download/ HEAD) >download.tar
      gzip -9 download.tar

install:
  - version: ">=4.5.0"
    shell: |
      cc --spock-triplet
      python --version

      cd download

      # Build static and shared libraries both at once
      CXX=c++ CC=cc python scripts/mk_make.py --prefix="$PACKAGE_ROOT" --staticlib
      cd build
      make -j$PARALLELISM
      make install

  - version: ">=4.6.0"
    shell: |
      cc --spock-triplet
      cd download

      # Build shared libraries
      mkdir _build
      cd _build
      cmake .. -DCMAKE_C_COMPILER=cc -DCMAKE_CXX_COMPILER=c++ -DCMAKE_INSTALL_PREFIX="$PACKAGE_ROOT" \
        -DBUILD_LIBZ3_SHARED:BOOL=YES -DBUILD_PYTHON_BINDINGS:BOOL=NO -DBUILD_JAVA_BINDINGS:BOOL=NO \
        -DBUILD_DOCUMENTATION:BOOL=NO
      make -j$PARALLELISM
      make install

      # Build static libraries
      cd ..
      rm -rf _build
      mkdir _build
      cd _build
      cmake .. -DCMAKE_C_COMPILER=cc -DCMAKE_CXX_COMPILER=c++ -DCMAKE_INSTALL_PREFIX="$PACKAGE_ROOT" \
        -DBUILD_LIBZ3_SHARED:BOOL=NO -DBUILD_PYTHON_BINDINGS:BOOL=NO -DBUILD_JAVA_BINDINGS:BOOL=NO \
        -DBUILD_DOCUMENTATION:BOOL=NO
      make -j$PARALLELISM
      make install
      
      # For backward compatibility. It would be nice to use a symlink here, but ROSE's mkinstaller doesn't support
      # symlinks.
      (cd "$PACKAGE_ROOT" && cp -pdr lib64 lib)
